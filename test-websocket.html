<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WebSocket Transport</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        input, button, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .coords {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
    </style>
</head>
<body>
    <h1>Test WebSocket Transport en Temps R√©el</h1>
    
    <div class="container">
        <!-- Panneau de connexion -->
        <div class="panel">
            <h3>üîó Connexion</h3>            <div>
                <label>URL du serveur:</label>
                <input type="text" id="serverUrl" value="http://localhost:3001" style="width: 100%;">
            </div>
            <div>
                <label>Token JWT:</label>
                <input type="text" id="jwtToken" placeholder="Votre token JWT" style="width: 100%;">
            </div>
            <div>
                <label>Type d'utilisateur:</label>
                <select id="userType">
                    <option value="client">Client</option>
                    <option value="chauffeur">Chauffeur</option>
                </select>
            </div>
            <div>
                <button id="connectBtn" onclick="connectToServer()">Se connecter</button>
                <button id="disconnectBtn" onclick="disconnectFromServer()" disabled>Se d√©connecter</button>
            </div>
            <div id="connectionStatus" class="status disconnected">D√©connect√©</div>
        </div>

        <!-- Panneau de transport -->
        <div class="panel">
            <h3>üöó Transport</h3>
            <div>
                <label>ID du transport:</label>
                <input type="number" id="transportId" value="1">
                <button onclick="joinTransport()" disabled id="joinBtn">Rejoindre</button>
                <button onclick="leaveTransport()" disabled id="leaveBtn">Quitter</button>
            </div>
            <div id="transportStatus"></div>
        </div>

        <!-- Panneau de position (chauffeur) -->
        <div class="panel">
            <h3>üìç Position (Chauffeur)</h3>
            <div class="coords">
                <div>
                    <label>Latitude:</label>
                    <input type="number" id="latitude" value="48.8566" step="0.000001">
                </div>
                <div>
                    <label>Longitude:</label>
                    <input type="number" id="longitude" value="2.3522" step="0.000001">
                </div>
            </div>
            <div>
                <label>Info statut:</label>
                <input type="text" id="statusInfo" placeholder="En route vers le client" style="width: 100%;">
            </div>
            <div>
                <button onclick="updatePosition()" disabled id="updatePosBtn">Mettre √† jour position</button>
                <button onclick="getCurrentLocation()">üìç Ma position</button>
            </div>
            <div id="lastPosition"></div>
        </div>

        <!-- Panneau de suivi automatique -->
        <div class="panel">
            <h3>‚è±Ô∏è Suivi Automatique</h3>
            <div>
                <button onclick="startAutoPosition()" disabled id="startAutoBtn">D√©marrer Auto</button>
                <button onclick="stopAutoPosition()" disabled id="stopAutoBtn">Arr√™ter Auto</button>
            </div>
            <div>
                <label>Intervalle (secondes):</label>
                <input type="number" id="interval" value="5" min="1" max="60">
            </div>
            <div id="autoStatus"></div>
        </div>
    </div>

    <!-- Logs -->
    <div style="margin-top: 20px;">
        <h3>üìã Logs en temps r√©el</h3>
        <button onclick="clearLogs()">Vider les logs</button>
        <div id="logs" class="log"></div>
    </div>

    <script>
        let socket = null;
        let currentTransportId = null;
        let autoPositionInterval = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logElement.innerHTML += `[${timestamp}] <span style="color: ${color}">${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const joinBtn = document.getElementById('joinBtn');
            const updatePosBtn = document.getElementById('updatePosBtn');
            
            if (connected) {
                statusEl.textContent = 'Connect√©';
                statusEl.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                joinBtn.disabled = false;
            } else {
                statusEl.textContent = 'D√©connect√©';
                statusEl.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                joinBtn.disabled = true;
                updatePosBtn.disabled = true;
                document.getElementById('leaveBtn').disabled = true;
            }
        }

        function connectToServer() {
            const serverUrl = document.getElementById('serverUrl').value;
            const token = document.getElementById('jwtToken').value;
            
            if (!token) {
                alert('Veuillez entrer un token JWT');
                return;
            }

            log('Tentative de connexion...', 'info');
            
            socket = io(`${serverUrl}/transport`, {
                auth: { token }
            });

            socket.on('connected', (data) => {
                log(`Connect√© avec succ√®s: ${JSON.stringify(data)}`, 'success');
                updateConnectionStatus(true);
                
                // Activer les boutons selon le type d'utilisateur
                if (data.userType === 'chauffeur') {
                    document.getElementById('updatePosBtn').disabled = false;
                    document.getElementById('startAutoBtn').disabled = false;
                }
            });

            socket.on('connect_error', (error) => {
                log(`Erreur de connexion: ${error.message}`, 'error');
                updateConnectionStatus(false);
            });

            socket.on('disconnect', (reason) => {
                log(`D√©connect√©: ${reason}`, 'warning');
                updateConnectionStatus(false);
                currentTransportId = null;
            });

            socket.on('error', (error) => {
                log(`Erreur: ${JSON.stringify(error)}`, 'error');
            });

            // √âv√©nements de transport
            socket.on('transport_joined', (data) => {
                log(`Transport rejoint: ${JSON.stringify(data)}`, 'success');
                currentTransportId = data.transportId;
                document.getElementById('leaveBtn').disabled = false;
                document.getElementById('transportStatus').innerHTML = `<strong>Transport ${data.transportId} rejoint</strong>`;
            });

            socket.on('transport_left', (data) => {
                log(`Transport quitt√©: ${JSON.stringify(data)}`, 'info');
                currentTransportId = null;
                document.getElementById('leaveBtn').disabled = true;
                document.getElementById('transportStatus').innerHTML = '';
            });

            // √âv√©nements de position
            socket.on('position_update', (data) => {
                log(`Position mise √† jour: Lat=${data.position.lat}, Lng=${data.position.lng}`, 'success');
                document.getElementById('lastPosition').innerHTML = 
                    `<strong>Derni√®re position:</strong><br>
                     Lat: ${data.position.lat}<br>
                     Lng: ${data.position.lng}<br>
                     ${data.statusInfo || ''}<br>
                     <small>${new Date(data.timestamp).toLocaleString()}</small>`;
            });

            socket.on('position_updated', (data) => {
                log(`Position confirm√©e: ${JSON.stringify(data)}`, 'success');
            });

            // √âv√©nements ETA
            socket.on('eta_update', (data) => {
                log(`ETA mise √† jour: ${data.durationRemaining}min, ${data.distanceRemaining}km`, 'info');
            });

            // Notifications
            socket.on('transport_notification', (data) => {
                log(`üì¢ Notification: ${data.message}`, 'warning');
            });

            socket.on('notification', (data) => {
                log(`üîî ${data.message}`, 'warning');
            });

            // √âv√©nements de suivi
            socket.on('tracking_started', (data) => {
                log(`Suivi d√©marr√© pour transport ${data.transportId}`, 'success');
            });

            socket.on('tracking_stopped', (data) => {
                log(`Suivi arr√™t√© pour transport ${data.transportId}`, 'info');
            });
        }

        function disconnectFromServer() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            updateConnectionStatus(false);
            stopAutoPosition();
        }

        function joinTransport() {
            const transportId = parseInt(document.getElementById('transportId').value);
            if (socket && transportId) {
                socket.emit('join_transport', { transportId });
                log(`Tentative de rejoindre le transport ${transportId}`, 'info');
            }
        }

        function leaveTransport() {
            if (socket && currentTransportId) {
                socket.emit('leave_transport', { transportId: currentTransportId });
                log(`Tentative de quitter le transport ${currentTransportId}`, 'info');
            }
        }

        function updatePosition() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            const statusInfo = document.getElementById('statusInfo').value;
            
            if (socket && currentTransportId) {
                socket.emit('update_position', {
                    transportId: currentTransportId,
                    latitude: lat,
                    longitude: lng,
                    statusInfo
                });
                log(`Position envoy√©e: ${lat}, ${lng} - ${statusInfo}`, 'info');
            } else {
                alert('Connectez-vous et rejoignez un transport d\'abord');
            }
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    document.getElementById('latitude').value = position.coords.latitude.toFixed(6);
                    document.getElementById('longitude').value = position.coords.longitude.toFixed(6);
                    log(`Position GPS obtenue: ${position.coords.latitude}, ${position.coords.longitude}`, 'success');
                }, (error) => {
                    log(`Erreur GPS: ${error.message}`, 'error');
                });
            } else {
                alert('G√©olocalisation non support√©e');
            }
        }

        function startAutoPosition() {
            const interval = parseInt(document.getElementById('interval').value) * 1000;
            
            if (autoPositionInterval) {
                clearInterval(autoPositionInterval);
            }
            
            autoPositionInterval = setInterval(() => {
                if (navigator.geolocation && socket && currentTransportId) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        socket.emit('update_position', {
                            transportId: currentTransportId,
                            latitude: lat,
                            longitude: lng,
                            statusInfo: 'Position automatique'
                        });
                        
                        document.getElementById('latitude').value = lat.toFixed(6);
                        document.getElementById('longitude').value = lng.toFixed(6);
                        
                        log(`Position auto envoy√©e: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'info');
                    }, (error) => {
                        log(`Erreur GPS auto: ${error.message}`, 'error');
                    });
                }
            }, interval);
            
            document.getElementById('startAutoBtn').disabled = true;
            document.getElementById('stopAutoBtn').disabled = false;
            document.getElementById('autoStatus').innerHTML = `<strong>Suivi automatique actif (${interval/1000}s)</strong>`;
            log(`Suivi automatique d√©marr√© (${interval/1000}s)`, 'success');
        }

        function stopAutoPosition() {
            if (autoPositionInterval) {
                clearInterval(autoPositionInterval);
                autoPositionInterval = null;
            }
            
            document.getElementById('startAutoBtn').disabled = false;
            document.getElementById('stopAutoBtn').disabled = true;
            document.getElementById('autoStatus').innerHTML = '';
            log('Suivi automatique arr√™t√©', 'info');
        }

        // Initialisation
        updateConnectionStatus(false);
        log('Interface de test WebSocket charg√©e', 'info');
        log('1. Entrez votre token JWT', 'info');
        log('2. Connectez-vous au serveur', 'info');
        log('3. Rejoignez un transport', 'info');
        log('4. Testez les fonctionnalit√©s', 'info');
    </script>
</body>
</html>
